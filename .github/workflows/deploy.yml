name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build frontend
      working-directory: ./frontend
      run: |
        npm ci
        npm run build

    - name: Deploy to EC2
      env:
        PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        HOSTNAME: ${{ secrets.EC2_HOSTNAME }}
        USER_NAME: ${{ secrets.EC2_USER_NAME }}
        DJANGO_SECRET_KEY: ${{ secrets.DJANGO_SECRET_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        echo "$PRIVATE_KEY" > private_key
        chmod 600 private_key

        # Step 1: Resolve Hostname to IP
        echo "Resolving ${HOSTNAME}..."
        SSH_TARGET=$(dig @1.1.1.1 +short ${HOSTNAME} | head -n1)
        if [[ -z "$SSH_TARGET" ]]; then
          echo "DNS resolution failed. Please check that ${HOSTNAME} points to your EC2 IP and try again in 5 minutes."
          exit 1
        fi
        echo "Connecting to ${HOSTNAME} (${SSH_TARGET})"

        # Step 2: Copy files and deployment script to EC2
        echo "--- Copying files to EC2 ---"
        scp -o StrictHostKeyChecking=no -i private_key -r frontend/build/* ${USER_NAME}@${SSH_TARGET}:/tmp/frontend_build/
        scp -o StrictHostKeyChecking=no -i private_key -r backend/* ${USER_NAME}@${SSH_TARGET}:/tmp/backend/
        scp -o StrictHostKeyChecking=no -i private_key deploy_script.sh ${USER_NAME}@${SSH_TARGET}:/home/ec2-user/

        # Step 3: Execute the deployment script on EC2
        echo "--- Executing deployment script on EC2 ---"
        ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${SSH_TARGET} "\
          chmod +x /home/ec2-user/deploy_script.sh && \
          export DJANGO_SECRET_KEY='${{ secrets.DJANGO_SECRET_KEY }}' && \
          export OPENAI_API_KEY='${{ secrets.OPENAI_API_KEY }}' && \
          export HOSTNAME='${HOSTNAME}' && \
          /home/ec2-user/deploy_script.sh
        "
